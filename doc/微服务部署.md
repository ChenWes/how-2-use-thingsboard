#### 环境准备

- 用于部署的机器，本文使用Centos7.8虚拟机，2核心4G内存
- Docker以及Docker Compose，Docker建议1.19.3+，Docker Compose建议1.27.0+
- 支持Html5的浏览器，本文使用Chrome

#### 描述

使用Docker Compose运行微服务集群，数据库使用Postgresql+Cassandra，消息队列使用Kafka。

#### 准备

- Docker安装（已有可跳过）
卸载旧版本
```
sudo yum remove docker \
                  docker-client \
                  docker-client-latest \
                  docker-common \
                  docker-latest \
                  docker-latest-logrotate \
                  docker-logrotate \
                  docker-engine
```
设置yum源仓库
```
sudo yum install -y yum-utils
sudo yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo
```
安装
```
sudo yum install docker-ce docker-ce-cli containerd.io
```
启动
```
sudo systemctl start docker
```
检查
```
docker version
```
测试
```
sudo docker run hello-world
```

- Docker Compose安装（已有可跳过）
下载
```
sudo curl -L "https://github.com/docker/compose/releases/download/1.29.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
```
授权
```
sudo chmod +x /usr/local/bin/docker-compose
```
检查
```
docker-compose --version
```

- 启动脚本下载（已有源码工程可跳过）
```
cd /path/to
git clone https://github.com/thingsboard/thingsboard.git

```

- 镜像获取
方式一，直接Docker hub拉取镜像
```
docker pull thingsboard/tb-node:3.2.2
docker pull thingsboard/tb-web-ui:3.2.2
docker pull thingsboard/tb-js-executor:3.2.2
docker pull thingsboard/tb-http-transport:3.2.2
docker pull thingsboard/tb-mqtt-transport:3.2.2
docker pull thingsboard/tb-coap-transport:3.2.2
```
方式二，拉取源码编译镜像
```
cd /path/to
git clone https://github.com/thingsboard/thingsboard.git
mvn clean install -DskipTests=true -Ddockerfile.skip=false
```


#### 安装
修改环境变量
```
sudo vi .env
```
内容如下
```
DATABASE=postgres
TB_QUEUE_TYPE=kafka
```
生成日志目录
```
cd /path/to/thingsboard/
sudo  ./docker-create-log-folders.sh
```
初始化环境
```
sudo ./docker-install-tb.sh –loadDemo
```
启动
```
sudo ./docker-start-services.sh
```
使用以下3组账号登录系统

- System Administrator: sysadmin@thingsboard.org / sysadmin
- Tenant Administrator: tenant@thingsboard.org / tenant
- Customer User: customer@thingsboard.org / customer

系统管理员首页如下

![部署系统管理员首页](../image/部署系统管理员首页.png)



#### 其他

- 问题定位
```
sudo docker-compose logs -f 
```
- 查看容器状态
```
sudo docker-compose ps

```
- 停止
```
sudo ./docker-stop-services.sh
```

- 更新
```
sudo ./docker-update-service.sh [SERVICE1,SERVICE2]
```
**SERVICE为需要更新的服务集合，如果不指定将会更新所有服务。**
- 卸载
```
sudo ./docker-remove-services.sh
```






#### TIPS

- [官方文档](https://thingsboard.io/docs/user-guide/install/cluster/docker-compose-setup/)
- 生产环境推荐使用k8s集群
- [Docker安装官方文档](https://docs.docker.com/install/)
- [Docker Compose安装官方文档](https://docs.docker.com/compose/install/)